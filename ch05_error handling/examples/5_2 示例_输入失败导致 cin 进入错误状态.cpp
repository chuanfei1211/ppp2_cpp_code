//cin 失败后不会自动恢复，必须手动清理：
//cin.clear() + cin.ignore()

//=====================================================
// 第5章 错误处理 —— 输入错误恢复示例
// 本文件目标：理解 cin.fail / cin.clear / cin.ignore 的作用
//=====================================================


/*
=====================================================
【核心问题：cin 输入失败会怎样？】
=====================================================

当我们执行：

    int x;
    cin >> x;        // 用户输入 abc

cin 会发生两件事：

① 输入格式不匹配 → cin 进入失败状态（failbit = true）
② 输入缓冲区里还残留 “abc\n” 这些垃圾字符

结果就是：

- cin 不会再读新输入
- 任意 while(cin >> x) 会陷入“死循环”
- 必须手动恢复


=====================================================
【failbit —— cin 的失败状态】
=====================================================

if (!cin) {
    // cin 处于失败状态（fail）
}

如果 cin.fail() 为 true：
- cin 不会从键盘再读取任何内容
- cin >> x 立即失败，不等待输入
- 程序进入死循环

因此：必须手动恢复！


=====================================================
【clear() —— 修复 cin 的状态】
=====================================================

cin.clear();

作用：
- 把 cin 从失败状态恢复为正常状态
- 否则 cin 不会继续读取任何东西

但注意：仅 clear() 还不够，
因为输入缓冲区里仍然残留错误字符“abc\n”。


=====================================================
【ignore() —— 丢弃输入缓冲区的垃圾】
=====================================================

cin.ignore(10000, '\n');

作用：
- 把输入缓冲区里剩下的所有垃圾丢掉
- 丢到 '\n'（换行符）为止
- 10000 只是一个足够大的数字（大多数写法都这样）

这样 cin 才能重新读取新输入。


=====================================================
【固定恢复公式（必须记）】
=====================================================

    cin.clear();               // ① 恢复状态
    cin.ignore(10000, '\n');   // ② 清除垃圾

=====================================================
*/


#include <iostream>
using namespace std;


//=====================================================
// 函数：要求用户输入整数，如果输入错误，重复提示
//=====================================================
int read_int()
{
    int x;

    while (true)        // 循环直到用户输入有效整数
    {
        cout << "请输入整数：";
        cin >> x;       // 尝试读入整数

        if (!cin)       // 如果输入错误（比如输入 abc）
        {
            cout << "输入不是整数，请重新输入！\n";

            cin.clear();                // ① 修复 cin 的错误状态
            // 如果不 clear，cin 会一直“坏掉”，无法继续输入

            cin.ignore(10000, '\n');    // ② 丢弃缓冲区的垃圾
            // 如果不 ignore，输入缓冲区中仍残留“abc\n”，cin 下次仍旧失败

            continue;   // 继续下一轮输入
        }

        // 输入正常
        return x;
    }
}



//=====================================================
// 主函数：测试 read_int()
//=====================================================
int main()
{
    int value = read_int();             // 反复要求输入直到正确
    cout << "你输入的是：" << value << endl;

    return 0;
}



/*
=====================================================
【总结：cin 输入错误恢复机制】
=====================================================

✔ 输入错误：cin.fail = true
✔ clear()：把 cin 修复正常
✔ ignore()：丢弃缓冲区中错误的输入数据
✔ 这两个必须配合使用，否则会：

    - 程序死循环
    - cin 不再等待输入
    - 用户永远无法再输入新数据

=====================================================
*/
